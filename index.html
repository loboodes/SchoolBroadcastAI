<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مخطط الدروس الذكي | Lobodes Ultimate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary-green: #1b4332; --gold-accent: #d4af37; }
        body { background-color: #f8f9fa; font-family: 'Tajawal', sans-serif; }
        .main-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, #2d6a4f 100%);
            color: white; padding: 50px 0; border-bottom: 5px solid var(--gold-accent);
            border-radius: 0 0 40px 40px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .glass-card {
            background: white; border-radius: 20px; padding: 35px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08); margin-top: -40px;
        }
        .btn-gold { background-color: var(--gold-accent); color: var(--primary-green); font-weight: bold; border: none; }
        .result-container { background: white; padding: 40px; border-radius: 15px; border: 1px solid #e0e0e0; margin-top: 30px; position: relative; }
        .pdf-header { border-bottom: 2px solid var(--gold-accent); padding-bottom: 15px; margin-bottom: 25px; }
        #debugArea { font-size: 0.8rem; background: #333; color: #0f0; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: left; direction: ltr; display: none; }
    </style>
</head>
<body>

<header class="main-header text-center">
    <h1 class="fw-bold">✨ مخطط الدروس الذكي Pro</h1>
    <p class="lead text-white-50">الجيل القادم من التحضير التربوي</p>
</header>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="glass-card">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">المادة الدراسية</label>
                        <input type="text" id="subjectInput" class="form-control" placeholder="مثلاً: علوم">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">اسم الدرس</label>
                        <input type="text" id="lessonInput" class="form-control" placeholder="مثلاً: البراكين">
                    </div>
                    <div class="col-12 mt-4">
                        <button onclick="startUltimateGeneration()" id="mainBtn" class="btn btn-gold btn-lg w-100 shadow">توليد التحضير الاحترافي</button>
                        <div id="statusMsg" class="text-center mt-3 text-muted"></div>
                    </div>
                </div>
            </div>

            <div id="debugArea"></div>

            <div id="outputWrapper" class="d-none">
                <div id="printablePlan" class="result-container">
                    <div class="pdf-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-success fw-bold mb-0">متجر Lobodes الرقمي</h4>
                            <small class="text-muted">نظام التحضير الذكي v2.0</small>
                        </div>
                    </div>
                    <h3 id="planTitle" class="text-center fw-bold mb-4" style="color: var(--primary-green);"></h3>
                    <div id="contentArea" style="white-space: pre-wrap; line-height: 1.8;"></div>
                </div>
                <button onclick="downloadAsPDF()" class="btn btn-success btn-lg w-100 mt-4 shadow">حفظ كملف PDF</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    const API_KEY = "AIzaSyA4JrK-4MnPur1nj9c5Se0gbQhyw_gSK18";
    
    // قائمة الموديلات التي سنجربها (الأحدث ثم الأقدم ثم المستقر)
    const MODELS = [
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`,
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`,
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.0-pro:generateContent?key=${API_KEY}`,
        `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${API_KEY}`, 
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`
    ];

    window.startUltimateGeneration = async () => {
        const subject = document.getElementById('subjectInput').value;
        const lesson = document.getElementById('lessonInput').value;
        const btn = document.getElementById('mainBtn');
        const statusDiv = document.getElementById('statusMsg');
        const debugArea = document.getElementById('debugArea');

        if (!subject || !lesson) return alert("فضلاً أدخل البيانات كاملة");

        btn.disabled = true;
        debugArea.style.display = 'none';
        
        const promptText = `بصفتك خبيراً تربوياً، صمم تحضير درس احترافي لمادة (${subject}) عنوانه (${lesson}) يشمل: الأهداف السلوكية، الاستراتيجيات، والوسائل التعليمية.`;

        let success = false;

        // حلقة المحاولة عبر الموديلات المختلفة
        for (const url of MODELS) {
            try {
                // استخراج اسم الموديل للتوضيح
                let modelName = "Unknown";
                if(url.includes("/models/")) modelName = url.split('/models/')[1].split(':')[0];
                
                statusDiv.innerText = `جاري المحاولة عبر المحرك: ${modelName}...`;

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });

                if (!response.ok) throw new Error("Not Found");

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                // نجاح!
                document.getElementById('planTitle').innerText = `تحضير درس: ${lesson}`;
                document.getElementById('contentArea').innerText = text;
                document.getElementById('outputWrapper').classList.remove('d-none');
                window.scrollTo({ top: document.getElementById('outputWrapper').offsetTop - 20, behavior: 'smooth' });
                
                success = true;
                statusDiv.innerText = "تم التوليد بنجاح! ✅";
                break; 

            } catch (e) {
                console.warn(`Failed: ${url}`);
                continue; 
            }
        }

        // إذا فشلت كل المحاولات، نقوم بالتشخيص
        if (!success) {
            statusDiv.innerHTML = "<span class='text-danger'>فشلت المحاولات. جاري تشخيص المفتاح...</span>";
            await diagnoseKey();
        }

        btn.disabled = false;
        if(!success) btn.innerText = "حاول مرة أخرى";
    };

    // دالة التشخيص: تسأل جوجل "ماذا لديك؟"
    async function diagnoseKey() {
        const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`;
        const debugArea = document.getElementById('debugArea');
        
        try {
            const response = await fetch(listUrl);
            const data = await response.json();
            
            if (data.models) {
                let availableModels = data.models.map(m => m.name).join('<br>');
                debugArea.innerHTML = `<strong>الموديلات المتاحة لمفتاحك هي:</strong><br>${availableModels}<br><br>الرجاء تصوير هذه الشاشة وإرسالها للمطور.`;
                debugArea.style.display = 'block';
            } else {
                debugArea.innerHTML = `خطأ في المفتاح: ${JSON.stringify(data)}`;
                debugArea.style.display = 'block';
            }
        } catch (e) {
            debugArea.innerHTML = `فشل الاتصال التشخيصي: ${e.message}`;
            debugArea.style.display = 'block';
        }
    }

    window.downloadAsPDF = () => {
        const element = document.getElementById('printablePlan');
        html2pdf().from(element).save(`تحضير_${document.getElementById('lessonInput').value}_Lobodes.pdf`);
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مخطط الدروس الذكي | Lobodes Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary-green: #1b4332; --gold-accent: #d4af37; }
        body { background-color: #f8f9fa; font-family: 'Tajawal', sans-serif; }
        .main-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, #2d6a4f 100%);
            color: white; padding: 50px 0; border-bottom: 5px solid var(--gold-accent);
            border-radius: 0 0 40px 40px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .glass-card {
            background: white; border-radius: 20px; padding: 35px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08); margin-top: -40px;
        }
        .btn-gold { background-color: var(--gold-accent); color: var(--primary-green); font-weight: bold; border: none; }
        .result-container { background: white; padding: 40px; border-radius: 15px; border: 1px solid #e0e0e0; margin-top: 30px; position: relative; }
        .pdf-header { border-bottom: 2px solid var(--gold-accent); padding-bottom: 15px; margin-bottom: 25px; }
    </style>
</head>
<body>

<header class="main-header text-center">
    <h1 class="fw-bold">✨ مخطط الدروس الذكي Pro</h1>
    <p class="lead text-white-50">التحضير التربوي المبتكر لمتجر Lobodes</p>
</header>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="glass-card">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">المادة الدراسية</label>
                        <input type="text" id="subjectInput" class="form-control" placeholder="مثلاً: علوم، رياضيات..">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">اسم الدرس</label>
                        <input type="text" id="lessonInput" class="form-control" placeholder="مثلاً: البراكين">
                    </div>
                    <div class="col-12 mt-4">
                        <button onclick="generatePlan()" id="mainBtn" class="btn btn-gold btn-lg w-100 shadow">توليد التحضير الاحترافي</button>
                    </div>
                </div>
            </div>

            <div id="outputWrapper" class="d-none">
                <div id="printablePlan" class="result-container">
                    <div class="pdf-header d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="text-success fw-bold mb-0">متجر Lobodes الرقمي</h4>
                            <small class="text-muted">نظام التحضير الذكي v1.0</small>
                        </div>
                    </div>
                    <h3 id="planTitle" class="text-center fw-bold mb-4" style="color: var(--primary-green);"></h3>
                    <div id="contentArea" style="white-space: pre-wrap; line-height: 1.8;"></div>
                </div>
                <button onclick="downloadAsPDF()" class="btn btn-success btn-lg w-100 mt-4 shadow">حفظ كملف PDF</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // مفتاحك الشخصي المستخرج من الصور
    const API_KEY = "AIzaSyA4JrK-4MnPur1nj9c5Se0gbQhyw_gSK18";
    
    // الرابط المحدث لضمان استدعاء النموذج بشكل صحيح
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`;

    window.generatePlan = async () => {
        const subject = document.getElementById('subjectInput').value;
        const lesson = document.getElementById('lessonInput').value;
        const btn = document.getElementById('mainBtn');

        if (!subject || !lesson) return alert("فضلاً أدخل البيانات كاملة");

        btn.disabled = true;
        btn.innerText = "جاري الاتصال بالذكاء الاصطناعي...";

        const promptText = `صمم تحضير درس احترافي لمادة (${subject}) عنوانه (${lesson}) يشمل الأهداف السلوكية، الاستراتيجيات، والوسائل التعليمية.`;

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });

            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error ? data.error.message : "خطأ غير معروف");

            document.getElementById('planTitle').innerText = `تحضير درس: ${lesson}`;
            document.getElementById('contentArea').innerText = data.candidates[0].content.parts[0].text;
            document.getElementById('outputWrapper').classList.remove('d-none');
            window.scrollTo({ top: document.getElementById('outputWrapper').offsetTop - 20, behavior: 'smooth' });

        } catch (error) {
            // حل مشكلة "Model not found" عبر تبديل الموديل برمجياً إذا فشل الأول
            if(error.message.includes("not found")) {
                alert("جاري التبديل لمحرك بديل.. حاول مرة أخرى الآن");
                // يمكنك هنا تغيير الرابط لـ gemini-1.5-flash-latest وتجربة الطلب مجدداً
            } else {
                alert("حدث خطأ: " + error.message);
            }
        } finally {
            btn.disabled = false;
            btn.innerText = "توليد التحضير الاحترافي";
        }
    };

    window.downloadAsPDF = () => {
        const element = document.getElementById('printablePlan');
        html2pdf().from(element).save(`تحضير_${document.getElementById('lessonInput').value}.pdf`);
    };
</script>
</body>
</html>
